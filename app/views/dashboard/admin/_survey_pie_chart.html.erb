<div class="bg-white rounded-lg shadow-sm p-6 h-[30rem] flex flex-col">
  <h3 class="text-lg font-semibold mb-4">Survey Ratings</h3>
  
  <div class="flex flex-col items-center flex-grow justify-center">
    <%# Pie chart container with fixed height %>
    <div class="w-64 h-64 relative">
      <%
        total = @surveys_by_rating.values.sum.to_f
        start_angle = 0
        colors = {
          1 => "#FF9999", # light red
          2 => "#E5E5E5", # light grey
          3 => "#D3D3D3", # medium grey
          4 => "#C0C0C0", # darker grey
          5 => "#A9A9A9"  # darkest grey
        }
      %>
      <svg viewBox="0 0 100 100" class="w-full h-full transform -rotate-90">
        <% @surveys_by_rating.each do |rating, count| %>
          <% 
            percentage = count / total
            angle = percentage * 360
            end_angle = start_angle + angle
            
            start_x = 50 + 40 * Math.cos(start_angle * Math::PI / 180)
            start_y = 50 + 40 * Math.sin(start_angle * Math::PI / 180)
            end_x = 50 + 40 * Math.cos(end_angle * Math::PI / 180)
            end_y = 50 + 40 * Math.sin(end_angle * Math::PI / 180)
            large_arc = angle > 180 ? 1 : 0
          %>
          <path 
            d="M 50 50 L <%= start_x %> <%= start_y %> A 40 40 0 <%= large_arc %> 1 <%= end_x %> <%= end_y %> Z"
            fill="<%= colors[rating] %>"
          />
          <% start_angle = end_angle %>
        <% end %>
        
        <circle cx="50" cy="50" r="25" fill="white"/>
        
        <text x="50" y="50" 
              text-anchor="middle" 
              dominant-baseline="middle" 
              class="text-2xl font-semibold"
              fill="#333333"
              transform="rotate(90 50 50)">
          <%= total.to_i %>
        </text>
      </svg>
    </div>
    
    <%# Legend with fixed spacing %>
    <div class="mt-6 grid grid-cols-5 gap-4 justify-center w-full">
      <% @surveys_by_rating.sort.reverse.each do |rating, count| %>
        <div class="flex flex-col items-center">
          <div class="flex items-center mb-1">
            <div class="w-3 h-3 rounded-sm" style="background-color: <%= colors[rating] %>"></div>
          </div>
          <span class="text-sm text-gray-600"><%= rating %> Stars</span>
          <span class="text-xs text-gray-500">(<%= count %>)</span>
        </div>
      <% end %>
    </div>
  </div>
</div>